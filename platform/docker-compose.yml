# Platform services â€” run alongside the root docker-compose.yml stack.
#
# Usage (from repo root):
#   docker compose -f docker-compose.yml -f platform/docker-compose.yml up
#
# Or standalone with external services configured via environment variables.

services:

  platform-backend:
    build:
      context: platform/backend
      dockerfile: Dockerfile
    ports:
      - "8001:8001"
    environment:
      - ROOT_DIR=/workspace
      - MLFLOW_TRACKING_URI=${MLFLOW_TRACKING_URI:-http://mlflow:5000}
      - MLFLOW_EXPERIMENT_NAME=${MLFLOW_EXPERIMENT_NAME:-visionops-defect-detection}
      - MLFLOW_MODEL_NAME=${MLFLOW_MODEL_NAME:-visionops-yolov8n}
      - GRAFANA_URL=${GRAFANA_URL:-http://localhost:3000}
      - PROMETHEUS_URL=${PROMETHEUS_URL:-http://localhost:9090}
    volumes:
      - .:/workspace:ro
      - ./runs:/workspace/runs
      - ./data:/workspace/data
    working_dir: /workspace
    networks:
      - default
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/api/health"]
      interval: 15s
      timeout: 5s
      retries: 3

  platform-frontend:
    build:
      context: platform/frontend
      dockerfile: Dockerfile
    ports:
      - "3001:3001"
    environment:
      - VITE_API_URL=/api
      - VITE_GRAFANA_URL=${GRAFANA_URL:-http://localhost:3000}
      - VITE_MLFLOW_URL=${MLFLOW_UI_URL:-http://localhost:5001}
    depends_on:
      platform-backend:
        condition: service_healthy
    networks:
      - default

networks:
  default:
    name: visionops-defect-detection_default
    external: true
